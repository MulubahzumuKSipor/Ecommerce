"use client";

import Link from "next/link";
import CartButton from "./components/buttons/cart";
import { useState, useRef, useEffect } from "react";
import styles from "../ui/styles/navbar.module.css";
import { useRouter } from "next/navigation";

// Get token safely (runs in browser only)
const readToken = () => {
  if (typeof window === "undefined") return null;
  try {
    return localStorage.getItem("token");
  } catch {
    return null;
  }
};

export default function Nav() {
  const router = useRouter();
  const [openMenu, setOpenMenu] = useState<string | null>(null);
  const [isLoggedIn, setIsLoggedIn] = useState<boolean>(() => !!readToken());
  const [isMobileMenuOpen, setIsMobileMenuOpen] = useState<boolean>(false);
  const navRef = useRef<HTMLElement | null>(null);
  const intervalIdRef = useRef<number | null>(null);

  const toggleMenu = (menuName: string) => {
    setOpenMenu((prev) => (prev === menuName ? null : menuName));
  };

  const toggleMobileMenu = () => {
    setIsMobileMenuOpen((prev) => !prev);
    setOpenMenu(null); // close current dropdown when toggling mobile menu
  };

  const handleLogout = () => {
    try {
      localStorage.removeItem("token");
    } catch {}
    setIsLoggedIn(false);
    setOpenMenu(null);
    setIsMobileMenuOpen(false);
    // optionally broadcast logout for same-tab listeners
    try {
      // update a keyed value so storage event fires in other tabs
      localStorage.setItem("__auth__", String(Date.now()));
    } catch {}
    router.push("/auth/login");
  };

  // Check token on mount and set state
  useEffect(() => {
    // schedule state update after current stack completes
    const t = window.setTimeout(() => {
      setIsLoggedIn(!!readToken());
    }, 0);

    return () => clearTimeout(t);
  }, []);

  // Listen for storage events so login/logout in another tab updates this nav
  useEffect(() => {
    const onStorage = (e: StorageEvent) => {
      if (e.key === "token" || e.key === "__auth__") {
        setIsLoggedIn(!!readToken());
      }
    };
    window.addEventListener("storage", onStorage);
    return () => window.removeEventListener("storage", onStorage);
  }, []);

  // Optional fallback polling (commented) â€” not recommended unless you need it.
  // useEffect(() => {
  //   if (!isLoggedIn) {
  //     intervalIdRef.current = window.setInterval(() => {
  //       if (readToken()) {
  //         setIsLoggedIn(true);
  //         if (intervalIdRef.current) {
  //           clearInterval(intervalIdRef.current);
  //           intervalIdRef.current = null;
  //         }
  //       }
  //     }, 10000);
  //   }
  //   return () => {
  //     if (intervalIdRef.current) {
  //       clearInterval(intervalIdRef.current);
  //     }
  //   };
  // }, [isLoggedIn]);

  // Close menus on outside click or Escape
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (navRef.current && !navRef.current.contains(event.target as Node)) {
        setOpenMenu(null);
        setIsMobileMenuOpen(false);
      }
    };

    const handleEscapeKey = (event: KeyboardEvent) => {
      if (event.key === "Escape") {
        setOpenMenu(null);
        setIsMobileMenuOpen(false);
      }
    };

    document.addEventListener("mousedown", handleClickOutside);
    document.addEventListener("keydown", handleEscapeKey);

    return () => {
      document.removeEventListener("mousedown", handleClickOutside);
      document.removeEventListener("keydown", handleEscapeKey);
    };
  }, []);

  // Close menus on route change (Next router push triggers re-render; this is defensive)
  useEffect(() => {
    const handleRouteChange = () => {
      setOpenMenu(null);
      setIsMobileMenuOpen(false);
    };
    // `router` from next/navigation doesn't expose events; we rely on push calls to reset in our code.
    // If you use the pages router, add `router.events.on("routeChangeStart", handleRouteChange)` here.
    // For app router, you can call setIsMobileMenuOpen(false) on Link clicks (already done).
    return () => {
      // cleanup if adding listeners for other router types
    };
  }, [router]);

  return (
    <nav className={styles.navbar} aria-label="Main Navigation" ref={navRef}>
      <button
        className={styles.hamburger}
        onClick={toggleMobileMenu}
        aria-expanded={isMobileMenuOpen}
        aria-controls="main-nav-list"
        aria-label={isMobileMenuOpen ? "Close menu" : "Open menu"}
      >
        {isMobileMenuOpen ? (
          // close icon
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden>
            <path d="M6 18L18 6M6 6L18 18" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
          </svg>
        ) : (
          // hamburger
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden>
            <path d="M3 12H21M3 6H21M3 18H21" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
          </svg>
        )}
      </button>

      <ul id="main-nav-list" className={`${styles.navList} ${isMobileMenuOpen ? styles.open : ""}`}>
        <li className={styles.navItem}>
          <Link href="/" className={styles.Link} onClick={() => setIsMobileMenuOpen(false)}>
            Home
          </Link>
        </li>

        {/* SHOP MENU */}
        <li className={`${styles.navItem} ${styles.megaMenuParent}`}>
          <button
            className="down_button"
            aria-haspopup="true"
            aria-expanded={openMenu === "shop"}
            onClick={() => toggleMenu("shop")}
          >
            Shop{" "}
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 48 48" aria-hidden>
              <path fill="none" stroke="currentColor" strokeLinecap="round" strokeLinejoin="round" strokeWidth="4" d="M36 18L24 30L12 18" />
            </svg>
          </button>

          {openMenu === "shop" && (
            <div className={`${styles.megaMenu} ${styles.main_wrapper}`} onClick={() => setIsMobileMenuOpen(false)}>
              <div className={styles.megaMenuColumn}>
                <Link href="/shop" className={styles.Link}>
                  Products
                </Link>
              </div>
              <div className={styles.megaMenuColumn}>
                <Link href="/specials" className={styles.Link}>
                  Special
                </Link>
              </div>
              <div className={styles.megaMenuColumn}>
                <Link href="/arrivals" className={styles.Link}>
                  New Arrivals
                </Link>
              </div>
              <div className={styles.megaMenuColumn}>
                <h3>Featured</h3>
                <ul>
                  <li>
                    <Link href="/bestsellers" className={styles.Link}>
                      Best Sellers
                    </Link>
                  </li>
                  <li>
                    <Link href="/sale" className={styles.Link}>
                      Hot Sale
                    </Link>
                  </li>
                </ul>
              </div>
            </div>
          )}
        </li>

        {/* ABOUT US MENU */}
        <li className={styles.navItem}>
          <button className="down_button" aria-haspopup="true" aria-expanded={openMenu === "about"} onClick={() => toggleMenu("about")}>
            About Us{" "}
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 48 48" aria-hidden>
              <path fill="none" stroke="currentColor" strokeLinecap="round" strokeLinejoin="round" strokeWidth="4" d="M36 18L24 30L12 18" />
            </svg>
          </button>
          {openMenu === "about" && (
            <div className={`${styles.megaMenu} ${styles.main_wrapper}`} onClick={() => setIsMobileMenuOpen(false)}>
              <div className={styles.megaMenuColumn}>
                <Link href="/about" className={styles.Link}>
                  Learn About Us
                </Link>
              </div>
              <div className={styles.megaMenuColumn}>
                <Link href="/contact" className={styles.Link}>
                  Contact Us
                </Link>
              </div>
              <div className={styles.megaMenuColumn}>
                <Link href="/faq" className={styles.Link}>
                  Frequently Asked Questions
                </Link>
              </div>
            </div>
          )}
        </li>

        {/* CONDITIONAL ACCOUNT/LOGIN/REGISTER */}
        {isLoggedIn ? (
          <li className={styles.navItem}>
            <button className="down_button" aria-haspopup="true" aria-expanded={openMenu === "account"} onClick={() => toggleMenu("account")}>
              My Account{" "}
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 48 48" aria-hidden>
                <path fill="none" stroke="currentColor" strokeLinecap="round" strokeLinejoin="round" strokeWidth="4" d="M36 18L24 30L12 18" />
              </svg>
            </button>
            {openMenu === "account" && (
              <div className={`${styles.megaMenu} ${styles.miniMenu} ${styles.main_wrapper}`}>
                <Link href="/account/manage" className={styles.Link} onClick={() => { setOpenMenu(null); setIsMobileMenuOpen(false); }}>
                  Manage Account
                </Link>
                <button
                  onClick={handleLogout}
                  className={styles.logoutButton}
                  style={{ width: "100%", textAlign: "left", background: "none", border: "none", padding: "10px 15px", cursor: "pointer", color: "inherit", fontSize: "large" }}
                >
                  Log Out
                </button>
              </div>
            )}
          </li>
        ) : (
          <>
            <li className={styles.navItem}>
              <Link href="/auth/login" className={styles.Link} onClick={() => setIsMobileMenuOpen(false)}>
                Login
              </Link>
            </li>
            <li className={styles.navItem}>
              <Link href="/auth/register" className={styles.Link} onClick={() => setIsMobileMenuOpen(false)}>
                Register
              </Link>
            </li>
          </>
        )}
      </ul>
    </nav>
  );
}
